<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Fastener Challenge | Paiho Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const TouchFastenerGame = () => {
            const [isPeeling, setIsPeeling] = useState(false);
            const [progress, setProgress] = useState(0);
            const [noiseLevel, setNoiseLevel] = useState(0);
            const [isWoke, setIsWoke] = useState(false);
            const [gameStarted, setGameStarted] = useState(false);

            const audioCtx = useRef(null);
            const noiseNode = useRef(null);
            const gainNode = useRef(null);
            const lastX = useRef(0); // æ”¹ç‚ºè¨˜éŒ„ X è»¸

            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    const bufferSize = 2 * audioCtx.current.sampleRate;
                    const noiseBuffer = audioCtx.current.createBuffer(1, bufferSize, audioCtx.current.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = Math.random() * 2 - 1;
                    }
                    noiseNode.current = audioCtx.current.createBufferSource();
                    noiseNode.current.buffer = noiseBuffer;
                    noiseNode.current.loop = true;
                    gainNode.current = audioCtx.current.createGain();
                    gainNode.current.gain.value = 0;
                    noiseNode.current.connect(gainNode.current);
                    gainNode.current.connect(audioCtx.current.destination);
                    noiseNode.current.start();
                }
                if (audioCtx.current.state === 'suspended') audioCtx.current.resume();
            };

            const handleStart = (e) => {
                if (!gameStarted || isWoke || progress >= 100) return;
                initAudio();
                setIsPeeling(true);
                lastX.current = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            };

            const handleMove = (e) => {
                if (!isPeeling || isWoke) return;
                const currentX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const delta = Math.max(0, currentX - lastX.current); // å‘å³æ’•é–‹
                
                if (delta > 0) {
                    const speed = delta * 3; 
                    setNoiseLevel(speed);
                    
                    if (gainNode.current) {
                        gainNode.current.gain.setTargetAtTime(Math.min(speed / 120, 0.4), audioCtx.current.currentTime, 0.05);
                    }

                    if (speed > 70) {
                        setIsWoke(true);
                        setIsPeeling(false);
                        gainNode.current.gain.value = 0;
                    }

                    setProgress(prev => {
                        const next = prev + delta * 0.3;
                        if (next >= 100) {
                            setIsPeeling(false);
                            if (gainNode.current) gainNode.current.gain.value = 0;
                            return 100;
                        }
                        return next;
                    });
                }
                lastX.current = currentX;
            };

            const handleEnd = () => {
                setIsPeeling(false);
                setNoiseLevel(0);
                if (gainNode.current) {
                    gainNode.current.gain.setTargetAtTime(0, audioCtx.current.currentTime, 0.1);
                }
            };

            return (
                <div 
                    className="flex flex-col items-center justify-center min-h-screen p-4 select-none overflow-hidden"
                    onMouseMove={handleMove}
                    onMouseUp={handleEnd}
                    onTouchMove={handleMove}
                    onTouchEnd={handleEnd}
                >
                    <h1 className="text-3xl font-black mb-2 text-white tracking-tight">
                        PAIHO TOUCH FASTENER
                    </h1>
                    <p className="text-slate-500 mb-12 text-sm">Interactive Physical Simulation</p>

                    <div className="relative w-48 h-48 mb-16 bg-slate-800 rounded-full flex items-center justify-center shadow-inner border border-slate-700">
                        <div className="text-7xl transition-all duration-300">
                            {isWoke ? 'ğŸ˜«' : (progress >= 100 ? 'ğŸ¥³' : 'ğŸ˜´')}
                        </div>
                        {/* å™ªéŸ³è­¦ç¤ºå¤–åœˆ */}
                        <div 
                            className="absolute inset-0 rounded-full border-4 border-red-500 opacity-0 transition-opacity"
                            style={{ opacity: noiseLevel / 100, transform: `scale(${1 + noiseLevel/200})` }}
                        />
                    </div>

                    {!gameStarted ? (
                        <button 
                            onClick={() => setGameStarted(true)}
                            className="bg-white text-slate-900 px-10 py-3 rounded-full font-bold shadow-lg hover:bg-slate-200 transition-all"
                        >
                            START CHALLENGE
                        </button>
                    ) : (
                        <div className="w-full max-w-md">
                            <div className="flex justify-between mb-3 text-xs font-mono text-slate-400 uppercase tracking-widest">
                                <span>Peeling Progress</span>
                                <span>{Math.floor(progress)}%</span>
                            </div>
                            
                            {/* æ©«å‘é€²åº¦æ¢æ§åˆ¶å€ */}
                            <div 
                                className="h-16 bg-slate-800 rounded-2xl relative overflow-hidden cursor-ew-resize border border-slate-700 shadow-lg"
                                onMouseDown={handleStart}
                                onTouchStart={handleStart}
                            >
                                {/* é€²åº¦å¡«å…… */}
                                <div 
                                    className="absolute inset-y-0 left-0 bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-150"
                                    style={{ width: `${progress}%` }}
                                />
                                {/* æŒ‡ç¤ºæ–‡å­— */}
                                <div className="absolute inset-0 flex items-center justify-center text-sm font-medium pointer-events-none">
                                    {isPeeling ? (
                                        <span className="animate-pulse text-white">å‘å³ç·©æ…¢æ‹–æ‹½...</span>
                                    ) : (
                                        <span className="text-slate-500">æŒ‰ä½ä¸¦å‘å³æ©«å‘æ’•é–‹</span>
                                    )}
                                </div>
                            </div>
                            
                            {isWoke && (
                                <button 
                                    onClick={() => window.location.reload()}
                                    className="mt-8 w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition-colors"
                                >
                                    å¯¶å¯¶é†’äº†ï¼é‡æ–°å˜—è©¦
                                </button>
                            )}
                            {progress >= 100 && (
                                <div className="mt-8 text-center text-emerald-400 font-bold text-lg animate-bounce">
                                    æˆåŠŸå®Œæˆï¼
                                </div>
                            )}
                        </div>
                    )}

                    <div className="mt-16 text-slate-600 text-[10px] text-center max-w-xs leading-relaxed uppercase tracking-tighter">
                        This simulation utilizes the physical characteristics of Taiwan Paiho Touch Fasteners.
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TouchFastenerGame />);
    </script>
</body>
</html>
