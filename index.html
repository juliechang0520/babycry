<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Fastener Challenge | Paiho Pixar Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .pixar-font { font-family: 'Luckiest Guy', cursive; }
        .bubbly-ui {
            box-shadow: inset 0 -8px 0 rgba(0,0,0,0.2), 0 8px 20px rgba(0,0,0,0.4);
            border: 4px solid rgba(255,255,255,0.2);
        }
        .bg-pixar-world {
            background: radial-gradient(circle at center, #60a5fa 0%, #1e40af 100%);
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-pixar-world text-white min-h-screen overflow-hidden font-['Noto_Sans_TC']">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Âö¥Ê†ºÂü∑Ë°å‰Ω†Ë®≠ÂÆöÁöÑËßíËâ≤Ê¢ù‰ª∂
        const characters = [
            { 
                id: 'dad', name: 'SUPER DAD', emoji: 'üë®', color: 'bg-orange-500', 
                sensitivity: 85, // Âô™Èü≥Ë≠¶Á§∫Ê¢ùÂçáÂæóÂø´
                speedMult: 1.5,  // ÊíïÈñãÈÄ≤Â∫¶Âä†ÂæóÂø´
                desc: 'ÂäõÈáèÈ©ö‰∫∫ÔºÅÈúÄÂ∞èÂøÉÊéßÂà∂' 
            },
            { 
                id: 'mom', name: 'SUPER MOM', emoji: 'üë©', color: 'bg-pink-500', 
                sensitivity: 70, 
                speedMult: 1.0, 
                desc: 'Âãï‰ΩúÊúÄÁ©©ÂÆöÁöÑÊ®ôÊ∫ñÈõ£Â∫¶' 
            },
            { 
                id: 'baby', name: 'TINY BABY', emoji: 'üë∂', color: 'bg-yellow-400', 
                sensitivity: 40, // Èõ£Â∫¶ÊúÄÈ´òÔºåÂô™Èü≥ÂÆπÂøçÂÄºÂè™Êúâ 40
                speedMult: 0.7, 
                desc: 'Ê•µÂ∫¶ÊïèÊÑüÔºÅÂøÖÈ†àÈùûÂ∏∏Á∑©ÊÖ¢' 
            }
        ];

        const TouchFastenerGame = () => {
            const [selectedChar, setSelectedChar] = useState(null);
            const [isPeeling, setIsPeeling] = useState(false);
            const [progress, setProgress] = useState(0);
            const [noiseLevel, setNoiseLevel] = useState(0);
            const [isWoke, setIsWoke] = useState(false);
            
            const audioCtx = useRef(null);
            const gainNode = useRef(null);
            const lastX = useRef(0);

            const initAudio = () => {
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    const buffer = audioCtx.current.createBuffer(1, audioCtx.current.sampleRate, audioCtx.current.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
                    const source = audioCtx.current.createBufferSource();
                    source.buffer = buffer; source.loop = true;
                    gainNode.current = audioCtx.current.createGain();
                    gainNode.current.gain.value = 0;
                    source.connect(gainNode.current);
                    gainNode.current.connect(audioCtx.current.destination);
                    source.start();
                }
                if (audioCtx.current.state === 'suspended') audioCtx.current.resume();
            };

            const handleMove = (e) => {
                if (!isPeeling || isWoke || progress >= 100) return;
                const currentX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const delta = Math.max(0, currentX - lastX.current);
                
                if (delta > 0) {
                    // Âô™Èü≥Ë®àÁÆóÈÄ£ÂãïËßíËâ≤Ê¢ù‰ª∂
                    const currentNoise = delta * 5; 
                    setNoiseLevel(currentNoise);
                    
                    if(gainNode.current) {
                        gainNode.current.gain.setTargetAtTime(Math.min(currentNoise / 100, 0.5), audioCtx.current.currentTime, 0.05);
                    }

                    // Âà§Êñ∑ÊòØÂê¶ÂêµÈÜí (‰æùÊìöËßíËâ≤ sensitivity)
                    if (currentNoise > selectedChar.sensitivity) {
                        setIsWoke(true);
                        setIsPeeling(false);
                        gainNode.current.gain.value = 0;
                    }

                    // ÈÄ≤Â∫¶Â¢ûÂä†ÈÄüÂ∫¶ (‰æùÊìöËßíËâ≤ speedMult)
                    setProgress(prev => Math.min(100, prev + delta * 0.3 * selectedChar.speedMult));
                }
                lastX.current = currentX;
            };

            const stopPeeling = () => {
                setIsPeeling(false);
                setNoiseLevel(0);
                if(gainNode.current) gainNode.current.gain.setTargetAtTime(0, audioCtx.current.currentTime, 0.1);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-8 select-none"
                     onMouseMove={handleMove} onMouseUp={stopPeeling}
                     onTouchMove={handleMove} onTouchEnd={stopPeeling}>
                    
                    <h1 className="pixar-font text-6xl mb-1 drop-shadow-lg text-yellow-400">PAIHO</h1>
                    <p className="text-xs font-black tracking-[0.4em] mb-10 opacity-90 uppercase">Touch Fastener Quest</p>

                    {!selectedChar ? (
                        <div className="flex flex-col gap-5 w-full max-w-sm">
                            <p className="text-center font-bold mb-2 text-blue-100">SELECT YOUR HERO</p>
                            {characters.map(char => (
                                <button key={char.id} onClick={() => setSelectedChar(char)}
                                    className={`${char.color} bubbly-ui p-5 rounded-3xl flex items-center gap-5 transition-all hover:scale-105 active:scale-95 group`}>
                                    <span className="text-5xl group-hover:animate-bounce">{char.emoji}</span>
                                    <div className="text-left">
                                        <div className="pixar-font text-2xl text-slate-900 leading-none">{char.name}</div>
                                        <div className="text-[10px] text-slate-800 font-bold mt-1 opacity-70">{char.desc}</div>
                                    </div>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="w-full max-w-md flex flex-col items-center">
                            {/* 3D ËßíËâ≤Â±ïÁ§∫ÂçÄ */}
                            <div className="relative w-64 h-64 mb-10 bg-white/20 rounded-full bubbly-ui flex items-center justify-center backdrop-blur-lg animate-float">
                                <div className={`text-9xl transition-all ${isPeeling ? 'scale-110' : ''}`}>
                                    {isWoke ? 'üí•' : (progress >= 100 ? 'üèÜ' : selectedChar.emoji)}
                                </div>
                                {/* Âô™Èü≥Áí∞ */}
                                <div className="absolute inset-0 rounded-full border-[10px] border-red-500 transition-opacity duration-75"
                                     style={{ opacity: noiseLevel / 100, transform: `scale(${1 + noiseLevel/100})` }} />
                            </div>

                            {/* Ê©´ÂêëÈÄ≤Â∫¶Ê¢ù */}
                            <div className="w-full bg-slate-900/50 p-3 rounded-[32px] bubbly-ui border-2 border-white/30">
                                <div className="h-20 bg-slate-800 rounded-[22px] relative overflow-hidden cursor-pointer shadow-inner"
                                     onMouseDown={(e) => {initAudio(); setIsPeeling(true); lastX.current = e.clientX;}}
                                     onTouchStart={(e) => {initAudio(); setIsPeeling(true); lastX.current = e.touches[0].clientX;}}>
                                    
                                    <div className="absolute inset-y-0 left-0 bg-gradient-to-r from-blue-400 via-cyan-300 to-white transition-all duration-150" 
                                         style={{ width: `${progress}%` }} />
                                    
                                    <div className="absolute inset-0 flex items-center justify-center font-black text-xl italic tracking-widest text-white/30">
                                        {isPeeling ? 'SLOWLY... SLOWLY...' : 'HOLD & SLIDE RIGHT'}
                                    </div>
                                </div>
                            </div>

                            {/* Â∫ïÈÉ®ÊéßÂà∂ÊåâÈàï */}
                            <div className="mt-10 flex gap-4 w-full font-black">
                                <button onClick={() => window.location.reload()} 
                                        className="flex-1 bg-white/20 py-4 rounded-2xl hover:bg-white/30 transition-all">MENU</button>
                                {isWoke && (
                                    <button onClick={() => {setProgress(0); setIsWoke(false);}} 
                                            className="flex-1 bg-red-500 py-4 rounded-2xl bubbly-ui animate-pulse">RETRY!</button>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="mt-16 opacity-40 text-[9px] font-bold tracking-[0.2em] text-center max-w-xs">
                        TECHNICAL SIMULATION BY TAIWAN PAIHO LIMITED
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TouchFastenerGame />);
    </script>
</body>
</html>
